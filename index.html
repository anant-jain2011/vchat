<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-Chat</title>
    <meta name="google-site-verification" content="67rdb6CJW98IpKb_qjIVqfLF1h4PWYGmqpNnE60DLJU" />
    <meta name="keywords" content="v-chat, vchat, vchats, v chat" />
    <style>
        * {
            margin: 0px;
            padding: 0px;
            font-family: sans-serif;
        }

        body {
            background-image: radial-gradient(#25D366, #fff);
            height: 100vh;
            overflow: hidden;
            width: 100vw;
        }

        .t-bar {
            position: fixed;
            top: 0px;
            width: 100%;
            height: 100px;
            display: flex;
            align-items: center;
            background-color: #25D366;
            justify-content: space-between;
        }

        .profile {
            border-radius: 50%;
            border: 2px solid black;
            height: 50px;
            width: 50px;
            margin-left: 10px;
        }

        .i-bar {
            display: flex;
            align-items: center;
        }

        /* .arrow {
            height: 35px;
            width: 35px;
            margin-left: 30px;
            border-radius: 50%;
        } */

        .name {
            font-weight: bold;
            margin-left: 20px;
            font-size: x-large;
            margin-right: 20px;
        }

        .c-bar {
            margin-right: 20px;
            display: flex;
            align-items: center;
        }

        .voi-c {
            height: 32px;
            width: 32px;
            margin-right: 20px;
        }

        .vid-c {
            height: 50px;
            width: 50px;
        }

        .t-dots {
            font-weight: bold;
            transform: rotateZ(90deg);
            font-size: 40px;
            margin-left: 15px;
            cursor: pointer;
            width: 40px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            border-radius: 25%;
            padding-bottom: 18px;
        }

        .t-dots::selection {
            background-color: transparent;
        }

        .om {
            width: 150px;
            right: 10px;
            top: 110px;
            background-color: #fff;
            border: 2px solid black;
            display: none;
            justify-content: space-around;
            align-items: center;
            flex-direction: column;
            list-style: none;
            position: absolute;
            float: right;
            border-radius: 15px;
        }

        li {
            cursor: pointer;
            border-top: 1px solid black;
            border-bottom: 1px solid black;
            width: 100%;
            text-align: center;
            padding-top: 10px;
            padding-bottom: 10px;
            margin-top: 0px;
            vertical-align: middle;
        }

        li:last-child {
            border-bottom: none;
        }


        li:first-child {
            border-top: none;
        }

        li::selection {
            background-color: transparent;
        }

        .m-bar {
            margin-top: 100px;
            width: 100%;
            height: calc(100% - 204px);
            overflow-y: scroll;
            overflow-x: hidden;
            padding-left: 10px;
            padding-right: 10px;
        }

        /* .m-bar2 {
            position: absolute;
        } */

        ::-webkit-scrollbar {
            appearance: none;
        }

        .messages {
            background-color: #000;
            height: auto;
            width: 100%;
        }

        .msg {
            margin: 5px 0px;
            display: inline;
            padding: 10px;
            border-radius: 3px;
            max-width: 50%;
            height: fit-content;
            width: fit-content;
            overflow-wrap: break-word;
            vertical-align: middle;
            text-align: center;
            font-size: larger;
        }

        .msg-left {
            background: #fff;
            float: left;
            clear: both;
            border-radius: 30px 30px 30px 0px;
        }

        .msg-right {
            background-color: #25D366;
            float: right;
            clear: both;
            border-radius: 30px 0px 30px 30px;
            padding-left: 12px;
        }

        @media only screen and (max-width: 440px) {
            .m-bar {
                height: calc(100% - 225px);
            }

            .c-bar {
                margin-right: -5px;
            }
        }

        .b-bar {
            position: fixed;
            bottom: 0px;
            width: 100%;
            height: 100px;
            display: flex;
            align-items: center;
            background-color: #aeaeae;
        }

        .form {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .input-box {
            display: flex;
            align-items: center;
            justify-content: center;
            bottom: 0;
            background-color: #fff;
            width: 70%;
            height: 50px;
            border-radius: 30px;
            margin-left: 10px;
        }

        input {
            border: none;
            font-size: large;
            margin-left: 20px;
            margin-right: 20px;
            width: 100%;
            border-radius: 30px;
            padding-left: 5px;
        }

        input:focus {
            outline: none;
        }

        .voice {
            margin-left: 10px;
            margin-right: 5px;
            border: none;
            border-radius: 50%;
            height: 60px;
            width: 60px;
        }

        .img1 {
            height: 60px;
            width: 60px;
            border-radius: 50%;
        }

        .send {
            margin-left: 10px;
            margin-right: 25px;
            border: none;
            border-radius: 50%;
            height: 60px;
            width: 60px;
            background-color: #25d369;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .img2 {
            aspect-ratio: 2 / 1;
            height: 32px;
            border-radius: 50%;
            margin-left: 7px;
        }

        #path {
            fill: #fff;
        }

        a {
            text-decoration: none;
            color: blue;
        }
    </style>
</head>

<body>
    <div class="t-bar" hidden>
        <div class="i-bar">
            <!-- <img src="https://cdn-icons-png.flaticon.com/128/507/507257.png" alt="" class="arrow"> -->
            <img src="./src/avatar.png" alt="" class="profile">
            <span class="name">V Chat</span>
        </div>
        <div class="c-bar">
            <img src="./src/phone-call-button.png" class="voi-c">
            <img src="./src/zoom.png" class="vid-c">
            <span class="t-dots" onclick="openOptionsMenu()">...</span>
        </div>
    </div>

    <div class="om" id="om">
        <li>Option 1</li>
        <li>Option 2</li>
        <li>Option 3</li>
        <li onclick="clearChats()">Clear Chats</li>
        <li>Leave Room</li>
    </div>

    <div class="m-bar">
        <div class="messages" id="messages">
        </div>
    </div>

    <div class="b-bar" hidden>
        <div class="voice">
            <img src="./src/voice.png" alt="" class="img1">
        </div>
        <div class="input-box">
            <input type="text" placeholder="Message" id="message">
        </div>
        <button type="submit" class="send" id="send" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" class="img2">
                <path fill="currentColor"
                    d="M1.101,21.757L23.8,12.028L1.101,2.3l0.011,7.912l13.623,1.816L1.112,13.845 L1.101,21.757z"
                    id="path"></path>
            </svg>
        </button>
    </div>

    <script>
        const msg = document.getElementById("message");
        const msgBox = document.getElementById("messages");
        const om = document.getElementById("om");

        let chats = {
            sent: [],
            received: [],
        };

        async function getChats() {
            const res = await fetch(`https://v-chat-bice.vercel.app/getChats`)

            return res.json();
        }

        const displayMessage = (content, position, id) => {
            var urlRegex = /https?:\/\/[^\s/$.?#].[^\s]*/g;
            if (content.match(urlRegex)) {
                content = content.replace(content.match(urlRegex), `<a href="${content.match(urlRegex)}" target="_blank">${content.match(urlRegex)}</a>`);
            }

            const newMsg = document.createElement("span");
            newMsg.classList.add(`msg`);
            newMsg.classList.add(`msg-${position}`);
            newMsg.innerHTML = content;

            const arrow = document.createElement("span");

            if (id) {
                newMsg.id = id;
            }

            msgBox.appendChild(newMsg);
        };

        window.onload = () => {
            if (!localStorage.getItem("username")) {
                const userName = prompt("What is your Name?");
                localStorage.setItem("username", userName);

                let roomNumber = Math.floor(Date.now() / 1000) * parseInt(Math.random() * 10);

                alert("Welcome to India's No.1 Chatting App. Your Room number is", roomNumber);

                (async function () {
                    try {
                        const res = await fetch("https://v-chat-bice.vercel.app/username", {
                            method: "POST",
                            mode: "no-cors",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded",
                            },
                            body: JSON.stringify({ userName }),
                        });
                    } catch (error) { }
                })();
            }

            msg.focus();

            getChats().then((messages) => {
                messages.map((message) => {
                    if (message.sentFrom == localStorage.getItem("username")) {
                        displayMessage(atob(atob(atob(message.content))), "right", message._id);
                    } else {
                        displayMessage(`<b>${message.sentFrom}:</b> ${atob(atob(atob(message.content)))}`, "left", message._id);
                    }
                });
            });

            if (!location.href.includes("autoRefresh")) {
                setInterval(() => {
                    let prevHTML;
                    getChats().then((data) => {
                        prevHTML = msgBox.innerHTML;
                        msgBox.innerHTML = "";
                        data.map((item) => {
                            if (item.sentFrom == localStorage.getItem("username")) {
                                displayMessage(atob(atob(atob(item.content))), "right", item._id);
                            } else {
                                displayMessage(`<b>${item.sentFrom}:</b> ${atob(atob(atob(item.content)))}`, "left", item._id);
                            }
                        });
                        if (prevHTML != msgBox.innerHTML) {
                            msgBox.lastElementChild.scrollIntoView(0, 0);
                        }
                    });
                }, 1000);
            }

            openOptionsMenu();
            document.getElementsByClassName("m-bar")[0].classList.toggle("m-bar2");
        };

        const sendMessage = () => {
            if (msg.value != "") {
                chats.sent.push(msg.value);
                localStorage.setItem("chats", JSON.stringify(chats));

                (async function () {
                    const res = await fetch("https://v-chat-bice.vercel.app/chat", {
                        method: "POST",
                        mode: "no-cors",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: JSON.stringify({
                            userName: localStorage.getItem("username"),
                            content: msg.value,
                            // roomNumber: localStorage.getItem("roomNumber"),
                        }),
                    });
                    displayMessage(msg.value, "right");
                })();

                msg.value = "";
                msgBox.scrollTop = msgBox.scrollHeight;
            }
            else {
                alert("Can't send empty message!");
            }
        };

        const openOptionsMenu = () => {
            let cond = om.style.display == "none";
            om.style.display = cond ? "flex" : "none";
            // document.getElementsByClassName("m-bar")[0].classList.toggle("m-bar2");
        };

        const clearChats = () => {
            const doClear = confirm("Do you sure want to clear your chats?");
            if (doClear) {
                chats.sent = [];
                localStorage.setItem("chats", JSON.stringify(chats));
                msgBox.innerHTML = "";
            }
        };
    </script>
</body>

</html>
